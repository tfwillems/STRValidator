<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>STR Concordance Inspector</title>

    {% assets "str_validator_js_all" %}
    <script type="text/javascript" src="{{ ASSET_URL }}"> </script>
    {% endassets %}

    <link rel=stylesheet type=text/css href="{{ url_for('static', filename='css/d3-tip.min.css') }}">
    <link rel=stylesheet type=text/css href="{{ url_for('static', filename='css/panelutil.css') }}">
    <link rel=stylesheet type=text/css href="{{ url_for('static', filename='css/alignmentviewer.css') }}">
    <link rel=stylesheet type=text/css href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <link rel=stylesheet type=text/css href="{{ url_for('static', filename='css/bootstrap-select.css') }}">
    
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css">
    <script src="//code.jquery.com/ui/1.11.2/jquery-ui.js"></script>
    <style>body { font-family: sans-serif; }</style>
    </head>
<body>

<div style="width: 100%; text-align:center">
<h3 style="display: inline-block">STR Concordance Inspector</h3>
</div>

<script>
function update_bubbleplot(){
   min_calls   = Math.exp($("#min_slider").slider("value"));
   max_calls   = Math.exp($("#max_slider").slider("value"));
   checked     = document.getElementById("diag_check").checked;
   scaling_fac = Math.exp($("#size_slider").slider("value"));
   d3.select("div#chart1").selectAll("circle").attr("r", function(d, i){
     if (d3.select(this).attr("z") < min_calls || d3.select(this).attr("z") > max_calls)
           return 0;
     else if (d3.select(this).attr("x") == d3.select(this).attr("y"))
        if (checked)
          return scaling_fac*Math.sqrt(+d3.select(this).attr("z"));
        else
          return 0;
     else {
        return scaling_fac*Math.sqrt(+d3.select(this).attr("z"));
    }
    });

var sizes = [];
d3.select("div#chart1").selectAll("circle").attr("r", function(d, i){
    sizes.push(+d3.select(this).attr("z"));
    return d3.select(this).attr("r");
});
max_size = d3.max(sizes);
min_size = d3.min(sizes)

// Set scrollbar limits

}

function update_comparison(){
$('#alignments').html('');
checked   = document.getElementById("diag_check").checked;
var comp  = document.getElementById("active_comparison").value;
min_calls = Math.exp($("#min_slider").slider("value"));
max_calls = Math.exp($("#max_slider").slider("value"));
var url   = "/set_comparison/" + comp;
$.getJSON(url, function(data) {
  d3.select("div#chart1").selectAll("svg").remove();
  draw_bubbleplot(checked, min_calls, max_calls);
});
}

function update_analysis(){
    
}
</script>

<div style="width: 40%; float:left; text-align:center">
  <div class="col-md-5 col-md-offset-1">
    <h4>Comparison</h4>
    <select id="active_comparison" class="selectpicker" data-style="btn-primary" data-width="175px" onchange="update_comparison()">
      {% for comp in comparisons %}
      <option>{{comp}}</option>
      {% endfor %}
    </select>
  </div>
  
  <div class="col-md-1"> 
    <h4>Analysis</h4>
    <select id="active_analysis" class="selectpicker" data-style="btn-primary" data-width="125px" onchange="update_analysis()">
      {% for analysis in analyses %}
      <option>{{analysis}}</option>
      {% endfor %}
    </select>
  </div>

  <div id="plot_container">
    <div class="qtlcharts" id="chart1" style="display: inline-block"></div>
    <div id="size_slider" style="width: 40%; display: inline-block"></div>
    <div id="size_label"  style="width: 15%; display: inline-block"> <font color="blue" size="2">Size Scale:</font></div>
    <div id="size_value"  style="width: 5%; display: inline-block">1.0 </div>
    <div id="min_slider"  style="width: 40%; display: inline-block"></div> 
    <div id="min_label"   style="width: 15%; display: inline-block">  <font color="blue" size="2">Min Calls:</font></div>
    <div id="min_value"   style="width: 5%; display: inline-block">1.0 </div>
    <div id="max_slider"  style="width: 40%; display: inline-block"></div>
    <div id="max_label"   style="width: 15%; display: inline-block">  <font color="blue" size="2">Max Calls:</font></div>
    <div id="max_value"   style="width: 5%; display: inline-block">1.0 </div>
    <form action="">
      <input type="checkbox" id="diag_check" onchange = "update_bubbleplot()"> Display matching calls (diagonal) <br>
    </form>
  </div>
</div>

<div style="width: 60%; float:right">
  <h4 style="text-align:center">Alignments</h4>
  <p style="text-align:center" id="click_desc">Click on a bubble to visualize the associated alignments</p>
  <div id="alignments">
  </div>
</div>

<script type="text/javascript"> 
  $(document).ready(function(e) {
  $('.selectpicker').selectpicker();
  });


checked = document.getElementById("diag_check").checked = true;
draw_bubbleplot(true, 1, 10000); 
scaling_fac = 1.0;
$(function() { $("#size_slider").slider({min:Math.log(0.25), max:Math.log(1024),   value:Math.log(scaling_fac), step:Math.log(2)}); });
$(function() { $("#min_slider" ).slider({min:Math.log(1),    max:Math.log(100000), value:Math.log(1),           step:Math.log(100000)/15}); });
$(function() { $("#max_slider" ).slider({min:Math.log(1),    max:Math.log(100000), value:Math.log(100000),      step:Math.log(100000)/15}); });

// Set slider label values
$('#size_value').html((1.0).toFixed(3));
$('#min_value' ).html(Math.ceil(Math.exp(Math.log(1))));
$('#max_value' ).html(Math.floor(Math.exp(Math.log(100000))));

$("#size_slider").on("slidestop", function(event, ui) { return update_bubbleplot(); });
$("#min_slider").on("slidestop", function(event, ui)  { return update_bubbleplot(); });
$("#max_slider").on("slidestop", function(event, ui)  { return update_bubbleplot(); });
$("#size_slider").on("slide", function(event, ui) {  $('#size_value').html(Math.exp(ui.value).toFixed(3));  });
$("#min_slider" ).on("slide", function(event, ui) {  $('#min_value' ).html(Math.ceil(Math.exp(ui.value)));  });
$("#max_slider" ).on("slide", function(event, ui) {  $('#max_value' ).html(Math.floor(Math.exp(ui.value))); });
</script>

</body>
</html>
